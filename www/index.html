<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
    <title></title>

    <link href="lib/ionic/css/ionic.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">

    <!-- IF using Sass (run gulp sass first), then uncomment below and remove the CSS includes above
    <link href="css/ionic.app.css" rel="stylesheet">
    -->

    <!-- ionic/angularjs js -->
    <script src="lib/ionic/js/ionic.bundle.js"></script>

    <!-- cordova script (this will be a 404 during development) -->
    <script src="cordova.js"></script>

    <!-- your app's js -->
    <script src="js/app.js"></script>
    <script src="js/load.js"></script>
    <script type="text/javascript" charset="utf-8">


var regexDays = function(string)
{
  var days = new RegExp("(Mo)|(Tu)|(We)|(Th)|(Fr)|(Sa)|(Su)", "g");
  daysarr = string.match(days);
  return daysarr;

}


var regexHours = function(string)
{
  var hours = new RegExp("([0-9]|0[0-9]|1[0-9]|2[0-3]):[0-5][0-9](AM|PM)","g");
  hoursarr = string.match(hours);
  return hoursarr;

}

var getStartDate = function(string)
{ 
  var sub = string.substr(0,10)
  var startdate = new Date(sub);
  return startdate;

}

var getEndDate = function(string)
{
  var sub = string.substr(13,22);
  var enddate = new Date(sub);
  return enddate;

}
var classes = [];

//Edge Cases
// If a class is dropped it sometimes shows up with the status of dropped
// do not add to calendar
var geterdone = function() {
alert("STARTING GETERDONE");
t = document.getElementById('ptifrmtgtframe');
//The schedule is in an iframe so we need to use the document from that iframe instead
newdocument = t.contentWindow.document;
newdocument.getElementsByClassName('PSGROUPBOXWBO');
classrows = newdocument.getElementsByClassName('PSGROUPBOXWBO');
//start at 1 because 1st row is the controls
classes = []
for (var i = 1; i < classrows.length; i++) {
  var workingrow = classrows[i];
  var classnametr = workingrow.getElementsByClassName('PAGROUPDIVIDER')[0]
  var classname = classnametr.innerText;
  realindex = (i - 1).toString();
  var status = newdocument.getElementById("STATUS$" + realindex).innerText;
  var units = newdocument.getElementById("win0divDERIVED_REGFRM1_UNT_TAKEN$" + realindex).innerText;
  var grading = newdocument.getElementById("win0divGB_DESCR$" + realindex).innerText;

  var innerinfo = newdocument.getElementById('CLASS_MTG_VW$scroll$' + realindex);
  var innerinfoarr = innerinfo.children[0].children;
  //start at 1 because first row is garbage
  for (var j = 1; j < innerinfoarr.length; j++) {
    var newclass = {};
    var innerchildren = innerinfoarr[j].children;
      newclass.classnumber = innerchildren[0].innerText;
      newclass.section =  innerchildren[1].innerText;
      newclass.component =  innerchildren[2].innerText;
      var datetime =  innerchildren[3].innerText;
      newclass.room =  innerchildren[4].innerText;
      newclass.instructor =  innerchildren[5].innerText;
      var endstartdate =  innerchildren[6].innerText;

      newclass.classname = classname;
      newclass.status = status;
      newclass.units = units;
      newclass.grading = grading;

      newclass.occurences = regexDays(datetime);

      var hours = regexHours(datetime);
      newclass.starttime = hours[0];
      newclass.endtime = hours[1];


      newclass.startdate = getStartDate(endstartdate);
      newclass.enddate = getEndDate(endstartdate);

      console.log(newclass);

    classes.push(newclass);

  }

  console.log(classname);
  console.log(status);
  console.log(units);
  console.log(grading);


}
alert(classes[0].classname);
}

    // Wait for Cordova to load
    //
    document.addEventListener("deviceready", onDeviceReady, false);

    // Cordova is ready
    //
    function onDeviceReady() {
         var ref = window.open('https://myslice.syr.edu', '_blank', 'location=no', 'toolbar=no');
         ref.addEventListener('loadstop', function(event) {
                        alert(event.url);

             if(event.url == "https://myslice.syr.edu/psp/PTL9PROD/EMPLOYEE/EMPL/h/?tab=DEFAULT") {
              alert("LOGGED IN!!!!!!");
     
              $('a[href$="https://myslice.syr.edu/psp/PTL9PROD/EMPLOYEE/HRMS/c/SA_LEARNER_SERVICES.SSR_SSENRL_LIST.GBL?PORTALPARAM_PTCNAV=SYR_VW_CLASS_SCHEDULE_CREF&EOPP.SCNode=EMPL&EOPP.SCPortal=EMPLOYEE&EOPP.SCName=ADMN_STUDENT_SERVICES&EOPP.SCLabel=&EOPP.SCPTcname=PT_PTPP_SCFNAV_BASEPAGE_SCR&FolderPath=PORTAL_ROOT_OBJECT.SYR_CREF_ROOT_FOLDER.SYR_STUDENT_SRVCS_FOLDER.SYR_ENROLLMENT_FOLDER.SYR_VW_CLASS_SCHEDULE_CREF&IsFolder=false"]').click();
             }



             if (event.url == "https://myslice.syr.edu/psp/PTL9PROD/EMPLOYEE/HRMS/c/SA_LEARNER_SERVICES.SSR_SSENRL_LIST.GBL?PORTALPARAM_PTCNAV=SYR_VW_CLASS_SCHEDULE_CREF&EOPP.SCNode=EMPL&EOPP.SCPortal=EMPLOYEE&EOPP.SCName=ADMN_STUDENT_SERVICES&EOPP.SCLabel=&EOPP.SCPTcname=PT_PTPP_SCFNAV_BASEPAGE_SCR&FolderPath=PORTAL_ROOT_OBJECT.SYR_CREF_ROOT_FOLDER.SYR_STUDENT_SRVCS_FOLDER.SYR_ENROLLMENT_FOLDER.SYR_VW_CLASS_SCHEDULE_CREF&IsFolder=false")
             
             {
              alert("SDFDSFDSFSD");
                geterdone();
             }
         });
        
    }



    </script>
  </head>
  <body ng-app="starter">

    <ion-pane>
      <ion-header-bar class="bar-stable">
        <h1 class="title">Ionic Blank Starter</h1>
      </ion-header-bar>
      <ion-content>
      </ion-content>
    </ion-pane>
  </body>
</html>
