<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
    <title></title>

    <link href="lib/ionic/css/ionic.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">

    <!-- IF using Sass (run gulp sass first), then uncomment below and remove the CSS includes above
    <link href="css/ionic.app.css" rel="stylesheet">
    -->

    <!-- ionic/angularjs js -->
    <script src="lib/ionic/js/ionic.bundle.js"></script>

    <!-- cordova script (this will be a 404 during development) -->
    <script src="cordova.js"></script>

    <!-- your app's js -->
    <script src="js/app.js"></script>
    <script src="js/load.js"></script>
    <script type="text/javascript" charset="utf-8">
    // Wait for Cordova to load
//
document.addEventListener("deviceready", onDeviceReady, false);

// Cordova is ready
//


var addToCal = function() {

    alert("starting");
    for (var i = 0; i < classes.length; i++) {
        for (var j = 0; j < classes[i].occurences.length; j++) {
            var currentevent = classes[i];
            // beware: month 0 = january, 11 = december
            var title = currentevent.classnumber + " - " + currentevent.classname + " _ " + currentevent.component;
            var location = currentevent.room;
            var notes = "";
            var success = function(message) {
                alert("Success: " + JSON.stringify(message));
            };
            var error = function(message) {
                alert("Error: " + message);
            };

            //could add reminders if the user chooses?
            var calOptions = window.plugins.calendar.getCalendarOptions();
            calOptions.recurrence = "weekly";
            var day = 25;
            switch (currentevent.occurences[j]) {
                case "Mo":
                    day = day + 0;
                    break;
                case "Tu":
                    day = day + 2;
                    break;
                case "We":
                    day = day + 3;
                    break;
                case "Th":
                    day = day + 4;
                    break;
                case "Fr":
                    day = day + 5;
                    break;
                case "Sa":
                    day = day + 6;
                    break;
                case "Su":
                    day = day + 7;
                    break;
            }

            var rex = RegExp('^([0-9]|0[0-9]|1[0-9]|2[0-3]):([0-5][0-9])(AM|PM)','g');

            var startmatches = rex.exec(currentevent.starttime);
            rex.exec("")
            var endmatches = rex.exec(currentevent.endtime);
            var startDate;
            var endDate;




            var starthours = startmatches[2];
            var startminutes = startmatches[1];
            if(startmatches[2] > 12 &&  startmatches[3] =="PM")
            {
              starthours = startmatches[2] +12; 
            }

            startDate = new Date(2014, 7, day, starthours, startminutes, 0, 0);


            var endhours = endmatches[2];
            var endminutes = endmatches[1];
            if(endmatches[2] > 12 &&  endmatches[3] =="PM")
            {
              endhours = endmatches[2] +12; 
            }

            
            endDate = new Date(2014, 7, day, endhours, endminutes, 0, 0);


            calOptions.recurrenceEndDate = null;
            //new Date(2014, 7, day, 0, 0, 0, 0, 0);
            window.plugins.calendar.createEventWithOptions(title, location, notes, startDate, endDate, calOptions, success, error);


        }

    }
    alert("Finished");
};

var classes = [];

var iabRef = null;


function onDeviceReady() {
    var iabRef = window.open('https://myslice.syr.edu', '_blank', 'location=no', 'toolbar=no');
    iabRef.addEventListener('loadstop', function(event) {

        if (event.url == "https://myslice.syr.edu/psp/PTL9PROD/EMPLOYEE/EMPL/h/?tab=DEFAULT") {
            iabRef.executeScript({
                code: "localStorage.setItem( 'classes', '' );"
            });
            // Start an interval



            console.log(event);



            iabRef.executeScript({
                file: "https://gist.githubusercontent.com/rosslazer/144954e00137738adc6c/raw/02b7c02c404f47a447f7abaea8debb0117adc820/gistfile1.js"
            });

            alert("POST LOAD SCRIPT");


        }


        if (event.url == "https://myslice.syr.edu/psp/PTL9PROD/EMPLOYEE/HRMS/c/SA_LEARNER_SERVICES.SSR_SSENRL_LIST.GBL?PORTALPARAM_PTCNAV=SYR_VW_CLASS_SCHEDULE_CREF&EOPP.SCNode=EMPL&EOPP.SCPortal=EMPLOYEE&EOPP.SCName=ADMN_STUDENT_SERVICES&EOPP.SCLabel=&EOPP.SCPTcname=PT_PTPP_SCFNAV_BASEPAGE_SCR&FolderPath=PORTAL_ROOT_OBJECT.SYR_CREF_ROOT_FOLDER.SYR_STUDENT_SRVCS_FOLDER.SYR_ENROLLMENT_FOLDER.SYR_VW_CLASS_SCHEDULE_CREF&IsFolder=false")

        {
            alert("SDFDSFDSFSD");

            iabRef.executeScript({
                file: "https://gist.githubusercontent.com/rosslazer/e523982c2bcf039016e6/raw/54dabe41a68a4038778601bd84c858f0947abf1a/gistfile1.js"
            });



            var loop = setInterval(function() {

                // Execute JavaScript to check for the existence of a name in the
                // child browser's localStorage.
                iabRef.executeScript({
                        code: "localStorage.getItem( 'classes' )"
                    },
                    function(values) {
                        var name = values[0];

                        // If a name was set, clear the interval and close the InAppBrowser.
                        if (name) {
                            alert("2");

                            classes = JSON.parse(values);

                            alert("3");

                            clearInterval(loop);
                            alert("4");


                            iabRef.close();
                            alert("5");

                            addToCal();
                            alert("6");




                        }
                    }
                );


            });


        }
    });



iabRef.addEventListener('exit', iabClose);


}

function iabClose(event) {
    iabRef.removeEventListener('exit', iabClose);




}

    </script>
  </head>
<body ng-app="calendar" ng-controller="Calendar">

    <ion-pane>
      <ion-header-bar class="bar-stable">
        <h1 class="title">Ionic Blank Starter</h1>
      </ion-header-bar>
      <ion-content>

      <ion-list>
      <ion-item ng-repeat="event in events">
        {{event.title}}
      </ion-item>
    </ion-list>
      </ion-content>
    </ion-pane>
  </body>
</html>
